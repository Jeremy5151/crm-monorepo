datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64"]
}

model Lead {
  id        String   @id @default(uuid())

  // Имя (раздельно)
  firstName String?
  lastName  String?

  email     String?  @db.VarChar(320)
  phone     String?  @db.VarChar(50)
  ip        String?  @db.VarChar(45)
  country   String?  @db.Char(2)

  // Атрибутика
  aff       String?                // id аффилиата (ожидаем совпадение с X-API-Key)
  bx        String?                // код "бокса" (план отправки)
  funnel    String?                // оффер
  

  // UTM
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?

  // Доп
  clickid     String?
  comment     String?
  lang        String?
  useragent   String?
  url         String?

  // Служебные поля интеграции с брокером
  status      LeadStatus @default(NEW)
  sentAt      DateTime?  @db.Timestamptz(3) 
  externalId  String?
  autologinUrl String?
  brokerResp  Json?
  broker      String?    // название брокера, на которого был отправлен лид
  
  // Связь с пользователем
  userId      String?
  user        User?   @relation("UserLeads", fields: [userId], references: [id], onDelete: SetNull)                          

  // Произвольные параметры (sub1..sub20 и т.п.)
  attrs       Json?
  brokerStatus           String?      
  brokerStatusChangedAt  DateTime?    
  statusEvents LeadStatusEvent[] 
  createdAt   DateTime   @default(now())

  attempts    LeadBrokerAttempt[]
  groups      GroupToLead[]

  
  @@index([createdAt])
  @@index([status])
  @@index([email])
  @@index([phone])
  @@index([aff])
  @@index([bx])
  @@index([utmSource])
  @@index([utmMedium])
  @@index([utmCampaign])
  @@index([externalId])
  @@index([aff, createdAt])
  @@index([bx, createdAt])
}

model LeadBrokerAttempt {
  id           String   @id @default(cuid())
  leadId       String
  lead         Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  broker       String            // код брокера (например: MOCK, BROKER_A)
  attemptNo    Int               // порядковый номер попытки
  status       String            // текстовый статус попытки (OK/ERROR/и т.п.)
  responseCode Int?
  responseBody String?
  errorCode    String?
  durationMs   Int?

  // Полный запрос (для debugging)
  requestUrl   String?           // полный URL с параметрами
  requestHeaders Json?           // заголовки запроса
  requestBody  String?           // тело запроса в raw формате

  createdAt    DateTime @default(now())

  @@index([leadId, createdAt])
}
enum Role {
  BUYER
  ADMIN
  SUPERUSER
}

enum LeadStatus {
  NEW
  SENT
  FAILED
}

model ApiKey {
  id        String   @id @default(cuid())
  key       String   @unique           // то, что приходит в X-API-Key
  aff       String                      // id аффилиата
  name      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  role Role @default(BUYER)

  @@index([aff])
}

enum Visibility {
  SHOW
  MASK
  HIDE
}

model AffSettings {
  aff              String  @id
  nameVisibility   Visibility @default(SHOW)
  emailVisibility  Visibility @default(SHOW)
  phoneVisibility  Visibility @default(SHOW)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model LeadStatusEvent {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  kind      String   // "brokerStatus" | "crmStatus" ...
  from      String?
  to        String?
  createdAt DateTime @default(now())

  @@index([leadId, createdAt])
}

model BrokerTemplate {
  id           String   @id @default(cuid())
  code         String   @unique            // код брокера, например: TRACKBOX_FR
  name         String?
  templateName String?                     // название шаблона, например: Trackbox
  isActive     Boolean  @default(true)
  
  // Push: отправка лидов на брокера
  method       String   @default("POST")  // HTTP метод
  url          String                        // URL с плейсхолдерами
  headers      Json?
  body         String?
  params       Json?                         // параметры интеграции (partnerId, auth, funnelId и т.д.)
  
  // Password generation settings
  passwordLength    Int?     @default(8)   // длина пароля
  passwordUseUpper  Boolean? @default(true) // использовать заглавные буквы
  passwordUseLower  Boolean? @default(true) // использовать строчные буквы
  passwordUseDigits Boolean? @default(true) // использовать цифры
  passwordUseSpecial Boolean? @default(true) // использовать спецсимволы
  passwordSpecialChars String? @default("!@#$%") // какие спецсимволы использовать
  
  // Pull: получение статусов от брокера
  pullEnabled  Boolean  @default(false)    // включен ли Pull
  pullUrl      String?                      // URL для pull запросов
  pullMethod   String?  @default("POST")   // HTTP метод для pull
  pullHeaders  Json?                        // headers для pull
  pullBody     String?                      // body template для pull
  pullInterval Int?     @default(15)       // интервал опроса в минутах
  pullLastSync DateTime?                   // когда последний раз синхронизировали
  
  boxBrokers   BoxBroker[]                 // связь с боксами через приоритеты
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Box {
  id          String   @id @default(cuid())
  name        String                        // название бокса, например: "EU Premium"
  countries   String[]                      // коды стран (ISO 2-letter), например: ["FR", "DE"], пустой = любая
  isActive    Boolean  @default(true)       // активен ли бокс
  
  brokers     BoxBroker[]                   // брокеры с приоритетами
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([countries])
}

model BoxBroker {
  id         String   @id @default(cuid())
  boxId      String
  brokerId   String
  priority   Int                            // приоритет от 1 до 10 (1 = самый высокий)
  
  // Время доставки (опционально)
  deliveryEnabled Boolean @default(false)   // включена ли доставка по времени
  deliveryFrom    String?                   // время начала (HH:MM), например: "09:00"
  deliveryTo      String?                   // время окончания (HH:MM), например: "18:00"
  
  // Капа (лимит лидов)
  leadCap    Int?                           // максимальное количество лидов для этого брокера (null = без лимита)
  
  box        Box              @relation(fields: [boxId], references: [id], onDelete: Cascade)
  broker     BrokerTemplate   @relation(fields: [brokerId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now())
  
  @@unique([boxId, brokerId])              // один брокер только один раз в боксе
  @@unique([boxId, priority])              // один приоритет только один раз в боксе
  @@index([boxId, priority])
}

model CrmSettings {
  id        String   @id @default(cuid())
  timezone  String   @default("UTC")        // глобальный часовой пояс CRM
  theme     String   @default("light")      // Цветовая схема (light/dark/auto)
  language  String   @default("en")         // Язык интерфейса (ru/en)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("crm_settings")
}

enum UserRole {
  AFFILIATE        // Обычный аффилиат
  AFFILIATE_MASTER // Мастер аффилиат
  ADMIN            // Администратор
  SUPERADMIN       // Суперадмин
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String
  password    String   @default("changeme123")
  role        UserRole @default(AFFILIATE)
  isActive    Boolean  @default(true)
  apiKey      String   @unique @default(cuid())
  timezone    String   @default("UTC")
  language    String   @default("en")
  
  createdBy   String?
  parentId    String?
  lastLoginAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  parent         User?   @relation("UserToParent", fields: [parentId], references: [id], onDelete: SetNull)
  children       User[]  @relation("UserToParent")
  createdByUser  User?   @relation("CreatedUsers", fields: [createdBy], references: [id], onDelete: SetNull)
  createdUsers   User[]  @relation("CreatedUsers")
  leads          Lead[]  @relation("UserLeads")
  groups         GroupToUser[]
  
  @@map("users")
}

model Group {
  id          String        @id @default(cuid())
  name        String        @unique
  description String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  users       GroupToUser[]
  leads       GroupToLead[]
  
  @@map("groups")
}

model GroupToUser {
  id       String @id @default(cuid())
  groupId String
  userId   String
  
  group    Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("group_to_user")
}

model GroupToLead {
  id       String @id @default(cuid())
  groupId String
  leadId  String
  
  group    Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  lead     Lead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([groupId, leadId])
  @@index([groupId])
  @@index([leadId])
  @@map("group_to_lead")
}
